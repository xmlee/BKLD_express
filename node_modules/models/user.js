var dbConnect=require('../dao/db');

//注册界面
exports.register = function (req,res){
    if(req.body.password2===req.body.checkPassword){
        client=dbConnect.connect();
        result=null;
        dbConnect.selectFun(client,req.body.username,function (result){
            if(result[0]===undefined){
                dbConnect.insertFun(client,req.body.username,req.body.password2,function (err){
                    if(err) throw err;
                    else res.render('reg',{help3:'注册成功，可使用账号登录！'});
                });
            }else res.render('reg',{help3:'注册失败，该用户名已存在。'});});
    }else res.render('reg',{help3:'注册失败，请确认两次输入的密码相同。'});
};

//登录界面
exports.checklogin = function (req,res){
   if(req.session.islogin){
    res.locals.islogin = req.session.islogin;
    }
    if(req.cookies.islogin){
      req.session.islogin = req.cookies.islogin;
    return  res.redirect('/home');
    }
    else 
    	res.render('login',{help1:'',help2:''});
    
};

exports.login = function (req,res){
	  client=dbConnect.connect();
      result=null;
      dbConnect.selectFun(client,req.body.username,function (result){
        if(result[0]===undefined){
          res.render('login',{help1:'不存在该用户',help2:''});
        }else{
          if(result[0].password===req.body.password){
            req.session.islogin=req.body.username;
            res.locals.islogin=req.session.islogin;
            res.cookie('islogin',res.locals.islogin,{maxAge:60000});//写入cookies
            res.redirect('/home');
          }else{
            res.render('login',{help1:'',help2:'密码错误！'});
          }
        }
      });
};
//登出,清除session,回到初始界面
exports.logout = function (req,res){
   res.clearCookie('islogin');
   req.session.destroy();
   res.redirect('/login');
};
